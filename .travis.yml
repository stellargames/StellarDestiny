language: php

sudo: false

php:
  - 5.6
  - 7.0

cache:
  directories:
    - vendor
    - $HOME/.composer/cache

env:
  global:
    - APP_ENV=test
    - APP_DEBUG=false
    - APP_KEY=Tpk0wmVgmVvqMHIRGWgk1PTLvyCqs23e
    - DB_HOST=localhost
    - DB_DATABASE=stellardestiny
    - DB_USERNAME=root
    - DB_PASSWORD=
    - CACHE_DRIVER=file
    - SESSION_DRIVER=file
    - QUEUE_DRIVER=sync

addons:
    code_climate:
        repo_token: 9dc9de1806a63d84f4ea92fa303e30cee43d1e12c7e25f61530b96e38b2c2564

matrix:
  fast_finish: true

branches:
  only:
    - master

before_install:
  - travis_retry composer self-update

install:
  - mysql -e 'create database stellardestiny;'
  - travis_retry composer install --prefer-source --no-interaction
  - chmod -R 777 storage/
  - php artisan migrate --seed
  - php artisan serve --quiet 2>&1 >/dev/null &
  - sleep 5
  - vendor/bin/codecept build

script:
  - vendor/bin/codecept run --report --coverage-xml --env=travis

after_script:
  - vendor/bin/test-reporter --coverage-report=./tests/_output/coverage.xml

after_failure:
  - cat storage/logs/laravel.log
  - cat tests/_output/*
